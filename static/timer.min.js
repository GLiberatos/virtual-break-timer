let duration=0,remaining=0,timerInterval=null,imagePaths=[],currentImage=0,audioUnlocked=!1;const PRESETS={class:{title:"Class Starts",minutes:30,isClassStart:!0},coffee:{title:"Coffee Break",minutes:15,isClassStart:!1},lunch:{title:"Lunch Break",minutes:60,isClassStart:!1},lab:{title:"Lab Session",minutes:30,isClassStart:!1}};function initBackgroundRotation(){fetch("/images-list").then(e=>e.json()).then(e=>{imagePaths=e||[],rotateBackground(),setInterval(rotateBackground,3e4)}).catch(e=>console.error("Error loading images:",e))}function rotateBackground(){imagePaths.length&&(document.body.style.backgroundImage=`url('${imagePaths[currentImage]}')`,currentImage=(currentImage+1)%imagePaths.length)}function populateTimeDropdowns(){const e=document.querySelectorAll(".hours"),t=document.querySelectorAll(".minutes");e.forEach(e=>{e.innerHTML="";for(let t=0;t<=12;t++)e.innerHTML+=`<option value="${t}">${String(t).padStart(2,"0")}</option>`}),t.forEach(e=>{e.innerHTML="";for(let t=0;t<60;t++)e.innerHTML+=`<option value="${t}">${String(t).padStart(2,"0")}</option>`})}function wirePresetIcons(){document.querySelectorAll("[data-preset]").forEach(e=>{e.addEventListener("click",onPresetClick),e.addEventListener("keyup",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),onPresetClick(e))})})}function onPresetClick(e){const t=e.currentTarget.dataset.preset,n=PRESETS[t];n&&startPresetSession(n.title,n.minutes,!!n.isClassStart)}function wireGearToggle(){document.querySelectorAll("[data-gear='toggle']").forEach(e=>{e.addEventListener("click",toggleCustomForm),e.addEventListener("keyup",e=>{"Enter"!==e.key&&" "!==e.key||(e.preventDefault(),toggleCustomForm())})})}function wireSaveButton(){const e=document.getElementById("saveBtn");e&&e.addEventListener("click",saveCustomTimer)}function toggleCustomForm(){const e=document.getElementById("customForm");if(!e)return;if("block"===e.style.display)return void(e.style.display="none");const t="none"!==window.getComputedStyle(document.getElementById("timerScreen")).display;e.style.margin=t?"10px 0 0 40px":"10px auto 0",e.style.display="block"}function applyTemplateFromSelect(){const e=document.getElementById("customForm"),t=document.getElementById("templateSelect");if(!e||!t)return;const n=e.querySelector(".hours"),a=e.querySelector(".minutes"),r=e.querySelector(".customTitle");let o=0,s=0,i="";switch(t.value){case"coffee":o=0,s=15,i="Coffee Break";break;case"lunch":o=1,s=0,i="Lunch Break";break;case"lab":o=1,s=0,i="Lab Session";break;case"starting":o=0,s=30,i="Class Starts";break;default:o=0,s=0,i=""}n&&(n.value=o),a&&(a.value=s),r&&(r.value=i)}function saveCustomTimer(){const e=document.getElementById("customForm");if(!e)return;const t=e.querySelector(".hours"),n=e.querySelector(".minutes"),a=e.querySelector(".customTitle"),r=e.querySelector(".customDescription"),o=e.querySelector(".nextUp"),s=parseInt(t&&t.value||"0",10),i=parseInt(n&&n.value||"0",10),l=a&&a.value||"",u=r&&r.value||"",c=o&&o.value||"";startPresetSession(l||"Custom Timer",60*s+i);const d=document.getElementById("sessionTime");d&&u&&(d.innerHTML+=`<br>${u}`);const m=document.getElementById("nextUp");m&&(m.textContent=c?`Coming up next: ${c}`:""),e.style.display="none"}function unlockAudio(){if(audioUnlocked)return;const e=document.getElementById("alarmSound");if(!e)return;e.muted=!0;const t=e.play();t&&t.then(()=>{e.pause(),e.currentTime=0,e.muted=!1,audioUnlocked=!0}).catch(e=>console.log("Audio unlock failed:",e))}function updateStatusBadge(e,t){const n=document.getElementById("statusBadge");if(!n)return;const a=(e||"").toLowerCase();let r="In session";t||a.includes("class")?r="ðŸ“š Class starting soon":a.includes("coffee")?r="â˜• Break":a.includes("lunch")?r="ðŸ” Lunch break":a.includes("lab")&&(r="ðŸ§ª Lab in progress"),n.textContent=r}function updateUrgencyState(){const e=document.getElementById("timerScreen");e&&(e.classList.remove("warning","danger"),remaining>0&&remaining<=60?e.classList.add("danger"):remaining>60&&remaining<=300&&e.classList.add("warning"))}function startPresetSession(e,t,n=!1){duration=60*t,remaining=duration;const a=new Date,r=new Date(a.getTime()+6e4*t),o=document.getElementById("sessionTitle"),s=document.getElementById("sessionTime");o&&(o.textContent=e),s&&(s.innerHTML=n?`Class Starts at ${r.getHours()}:${String(r.getMinutes()).padStart(2,"0")}`:`Ends at ${r.getHours()}:${String(r.getMinutes()).padStart(2,"0")}`);const i=document.getElementById("nextUp");i&&(i.textContent=""),updateStatusBadge(e,n),updateDisplay(),updateUrgencyState();const l=document.getElementById("welcomeScreen"),u=document.getElementById("timerScreen");l&&(l.style.display="none"),u&&(u.style.display="block"),unlockAudio(),startTimer()}function updateDisplay(){const e=Math.floor(remaining/60),t=remaining%60,n=document.getElementById("timerDisplay");n&&(n.textContent=`${String(e).padStart(2,"0")}:${String(t).padStart(2,"0")}`),updateUrgencyState()}function startTimer(){timerInterval&&clearInterval(timerInterval),timerInterval=setInterval(()=>{remaining>0?(remaining--,updateDisplay()):(clearInterval(timerInterval),timerInterval=null,playSound())},1e3)}function playSound(){const e=document.getElementById("alarmSound");if(!e)return;e.volume=.5;const t=e.play();t&&t.catch(e=>console.log("Audio play failed:",e)),setTimeout(()=>{e.pause(),e.currentTime=0},5e3)}document.addEventListener("DOMContentLoaded",()=>{populateTimeDropdowns(),initBackgroundRotation(),wirePresetIcons(),wireGearToggle(),wireSaveButton()}),document.addEventListener("change",e=>{e.target&&"templateSelect"===e.target.id&&applyTemplateFromSelect()});